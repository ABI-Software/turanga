<!DOCTYPE html>
<html lang="en" style="height:100%">
	<head>
		<title>Turanga Lung Visualisations</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}fd
			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 100;
				display:block;
			}
			#info a, .button { color: #f00; font-weight: bold; text-decoration: underline; cursor: pointer }
		</style>
		
		
		<script>
  			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  				(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  			ga('create', 'UA-78357308-1', 'auto');
  			ga('send', 'pageview');

		</script>

  		<script>
	    	var dojoConfig = {
				async: true,
				// This code registers the correct location of the "demo" package
				// so we can load Dojo from the CDN whilst still being able to
				// load local modules
				packages: [{
					name: "js",
					location: location.pathname.replace(/\/[^/]+$/, '')  + '/js'
				}]
			};
			
    		function updateSlider(slideAmount) {
				this.zincRenderer.setMorphsTime(slideAmount * 30);
    		}
    	</script>
  		<script src="js/dat.gui.min.js"></script>
  		<link rel="stylesheet" type="text/css" href="styles/dat-gui-swec.css">
		<link rel="stylesheet" type="text/css" href="styles/my_style.css">
		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<script src="js/display_airways_flow.js"></script>
		<script src="js/three.min.js"></script>
		<script src="js/zinc_threejs_control.js"></script>
		<script src="js/zinc_3js_renderer.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  		<script src="http://ajax.googleapis.com/ajax/libs/dojo/1.10.4/dojo/dojo.js" data-dojo-config="async: 1, parseOnLoad: true" ></script>
	</head>

	<body style="height:100%">
		<div class="row">
			<div class="col-sm-3">
			</div>
			<div class="col-sm-1">
				<div id="playToggle" class="play"></div>
			</div>	
			<div class="col-sm-4">
				<input id="age_slider" type="range" min="0" max="100" value ="0" step="1" oninput="updateSlider(this.value)" style="height: 64px;"/>
			</div>
			<div class="col-sm-4">
			</div>
		</div>
		<div class="row">
			<div class="col-sm-5">
			</div>
			<div class="col-sm-2">
				<h3 id="renderer_Age" >
					Simulated Age: 0
				</h3>
			</div>
			<div class="col-sm-5">
			</div>
		</div>
		
		
		<div id="container">
			<div id="BackgroundImage">
				<a href="http://www.abi.auckland.ac.nz/en.html">
					<img src="images/abi-hc-rgb.png" style="width:55%">
				</a>
				<a href="http://www.turanga.org.nz/">
					<img src="images/turanga_banner_0_transparent.png" style="width:40%"> 
				</a>
			</div>
			<div class="sidebar sidebar-left sidebar-open" data-reactid=".0.1.0"  id="my_sidebar">
				<div class="sidebar-dock-button" data-reactid=".0.1.0.0" onclick="sidebar_click()">
				</div>
				<div class="sidebar-content-container" data-reactid=".0.1.0.1">
					<div class="sidebar-content" data-reactid=".0.1.0.1.0">
					  <div class="panel-group" id="accordion">
					  	<div class="panel panel-default">
					      <div class="panel-heading">
					        <h4 class="panel-title">
					          <a data-toggle="collapse" data-parent="#accordion" href="#collapseWelcome">Welcome to the Turanga Lungs Visualisation App</a>
					        </h4>
					      </div>
					      <div id="collapseWelcome" class="panel-collapse collapse in" >
					      	<ul>
							  <font size=5>
							    <p></p>
							    <font size=6>
									<p>Welcome and thanks for using the Turanga Lung Visualisation Application.</p>
								</font>
								<p></p>
								<p></p>
								<p>By using this app, you will:</p>
								<font size=4>
								  <li>Learn how smoking affects your health.</li>
	  							  <li>View lung models personalised with your smoking history.</li>
	  							  <li>Find out your estimated lung function as you age.</li>
  								</font>
  								<p></p>
  								<p>How to use:</p>
								<font size=4>
								  <li>Click on each tab (below) for more information.</li>
	  							  <li>Click on the blue vertical bar on the right to hide this panel and view the lungs. The blue vertical bar remains on the left and can be clicked to show this panel.</li>
	  							  <li>Click on “How about my lungs?” and enter details such as age, rate of smoking etc. which affect the lungs and their function. You can change these details at any time and see the effects immediately.</li>
	  							  <li>View the 3-D lungs using the mouse or touch screen controls (see the tab below). You can switch between viewing 3-D Models of lung surfaces illustrating tar build-up, and airways showing differences in flow compared to healthy individuals.</li>
	  							  <li>Adjust the time slider along the top of the screen to project to different ages. Click on the play button to animate.</li>
	  							  <li>Open the ‘Estimated Lung Function’ tab below and see how it changes with age and ceasing smoking.</li>
  								</font>
							  </font>
							</ul>
					      </div>
					    </div>
					    <div class="panel panel-default">
					      <div class="panel-heading">
					        <h4 class="panel-title">
					          <a data-toggle="collapse" data-parent="#accordion" href="#collapseControls">3D Viewer Controls</a>
					        </h4>
					      </div>
					      <div id="collapseControls" class="panel-collapse collapse">
					        <div>
								<img src="images/mouse_instruction_small.jpg" style="left: 10%;top: 100px;width:40%">
								<img src="images/touch_control.jpg" style="right: 10px;top: 100px;width: 40%">  

							</div>
					      </div>
					    </div>
					    <div class="panel panel-default">
					      <div class="panel-heading">
					        <h4 class="panel-title">
					          <a data-toggle="collapse" data-parent="#accordion" href="#lungPanel">Estimated Lung Functions</a>
					        </h4>
					      </div>
					      <div id="lungPanel" class="panel-collapse collapse">
					        <div class="panel-body">
								<div id="chartContainer">
									<div class="content">
										<div class="leftChart" id="predicted_lungAge">
											<p> <font size=4>Please enter and confirm your details </font></p>
				      					</div>
				      					<div class="rightChartTitle">
				      						<p> <font size=3>Graph of Forced Expiratory Volume (FEV1) compared with healthy 25 year old non-smoker, versus age in years.</font></p>
				      					</div>
										<div id = "fev_chart" class="rightChart">
				      					</div>
				      					<div class="rightLegend">
				      						<div id = "fev_legend">
				      						</div>
				      					</div>
				      				</div>
			      				</div>
							</div>
					      </div>
					    </div>
					   	<div class="panel panel-default">
					      <div class="panel-heading">
					        <h4 class="panel-title">
					          <a data-toggle="collapse" data-parent="#accordion" href="#copd_collpase">Smoking and COPD</a>
					        </h4>
					      </div>
					      <div id="copd_collpase" class="panel-collapse collapse">
							<ul>
								<font size=5>
								  	<p>Having COPD (chronic obstructive pulmonary disease) means that your airways are obstructed and the tissue inside the lungs is damaged.</p>
								  	<p>Over 15 percent of all smokers are likely to become affected. Statistics also shows that 85 - 90 percent of COPD arises from smoking in New Zealand and is the fourth leading cause of death after cancer, heart disease and stroke.</p>
						
								  	<font size=4>
								  		<li>Between one-third to half of all patients with COPD have sleep disorders.</li>
								  		<li>At least one-third of patients have their social activities affected, and 58 percent were going out less.</li>
								  		<li>22 percent needed regular help from family; 54 percent needed constant help.</li>
								  	</font>
								  	<p></p>
	  								<p>Unlike asthma, COPD is not reversible, however, quitting smoking is the best way to protect lungs from futher damage and keep COPD symptoms from getting worse.</p>			
  								</font>
							</ul>
					      </div>
					    </div>
					    
					    <div class="panel panel-default">
					      <div class="panel-heading">
					        <h4 class="panel-title">
					          <a data-toggle="collapse" data-parent="#accordion" href="#fact_collapse">Facts About Smoking</a>
					        </h4>
					      </div>
					      <div id="fact_collapse" class="panel-collapse collapse">
							<ul>
								<font size=5>
								  	<li>Tobacco smoke contains more than 7,000 chemicals, about 70 of which are known to cause cancer.</li>
	  								<li>About 30,000 people die in New Zealand each year and around 5,000 of those are caused by smoking or second-hand smoke.</li>
	  								<li>Half of all regular smokers die early from a smoking related disease.</li>
	  								<li>Internationally, tobacco smoke is responsible for about 1 in 10 adult deaths.</li>
	  								<li>Smoking affects sporting performance negatively; exercising requires oxygen but smoking reduces oxygen intake.</li>
  								</font>
							</ul>
					      </div>
					    </div>
					    
					   	<div class="panel panel-default">
					      <div class="panel-heading">
					        <h4 class="panel-title">
					          <a data-toggle="collapse" data-parent="#accordion" href="#mortality_collapse">Smoking Attributable Mortality</a>
					        </h4>
					      </div>
					      <div id="mortality_collapse" class="panel-collapse collapse">
					        <div style="margin: auto;">
					        	<ul>
					        	<font size=4>
					        		Proportions of smoking-attributed diseases causing death.
					        	</font>
					        	</ul>
								<img src="images/smoking_mortality_males.jpg" style="top: 100px;width:100%;max-width: 700px;">
								<img src="images/smoking_mortality_females.jpg" style="top: 100px;width:100%;max-width: 700px;">  
								<p>
								</p>
								<font size=3>
					        		Data above are findings of the Surgeon General's report in United State.
					        		Charts are produced by Kelly Burrowes. 
					        	</font>
							</div>
					      </div>
					    </div>
					    
					  </div>
					</div>
				</div>
			</div>
		</div>

		<script>
			

			var zincRenderer = null;
			
			$(document).ready(function() {
        		$('#playToggle').bind("click", function() {
          			if ($(this).attr("class") == "play")
          			{
             			$(this).attr("class", "pause");
             			zincRenderer.playAnimation = true;
             		}
          			else
          			{
             			$(this).attr("class", "play");
             			zincRenderer.playAnimation = false;	
             		}
        		});
      		});
			
			var cellUniforms= THREE.UniformsUtils.merge( [
				{
					"ambient"  : { type: "c", value: new THREE.Color( 0xffffff ) },
					"emissive" : { type: "c", value: new THREE.Color( 0x000000 ) },
					"specular" : { type: "c", value: new THREE.Color( 0x111111 ) },
					"shininess": { type: "f", value: 100 },
					"diffuse": { type: "c", value: new THREE.Color( 0xeecaa2 ) },
					"ambientLightColor": { type: "c", value: new THREE.Color( 0x444444 ) },
					"directionalLightColor": { type: "c", value: new THREE.Color( 0x888888 ) },
					"directionalLightDirection": { type: "v3", value: new THREE.Vector3()  },
					"time": { type: "f", value: 0.0 },
					"starting_time": { type: "f", value: 0.0 },
					"severity": { type: "f", value: 0.0 },
					"cellsDensity": { type: "f", value: 0.1 },
					"tarDensity":  { type: "f", value: 0.0175}
				}
			] );
			
			var flowUniforms= THREE.UniformsUtils.merge( [
			{
				"ambient"  : { type: "c", value: new THREE.Color( 0xffffff ) },
				"emissive" : { type: "c", value: new THREE.Color( 0x000000 ) },
				"specular" : { type: "c", value: new THREE.Color( 0x111111 ) },
				"shininess": { type: "f", value: 100 },
				"ambientLightColor": { type: "c", value: new THREE.Color( 0x444444 ) },
				"directionalLightColor": { type: "c", value: new THREE.Color( 0x888888 ) },
				"directionalLightDirection": { type: "v3", value: new THREE.Vector3()  },
				"time": { type: "f", value: 0.0 },
				"starting_time": { type: "f", value: 0.0 },
				"severity": { type: "f", value: 1.0 }
			} ] );
			
			var lungsScene = undefined;
			var airwaysScene = undefined;
			var lungMeshIsReady = false;
			var airwaysIsReady = false;
	  						
			var gender = {
				"Male":  "Male",
				"Female": "Female"
			};
			
			var viewingModel = {
				"Lungs (Tar)": "Lungs",
				"Airways": "Airways"				
			}
			
			/* Accourding to studies, asthma severity affects percentage FEV1 */
			var asthmaLevel = {
				"None" : 1.0,
				"Mild" : 0.8,
				"Moderate" : 0.7,
				"Severe": 0.6	
			}
		
			var userData = {
				'Current Age': 25,
				'Gender' : "Male",
				'Asthma Severity' : "None",
				'Age started smoking': 18,
				'Packs Per Day': 1.0,
				'Height' : 180,
				'3D Models' : "Lungs (Tar)",
				'Speed' : 500
			};
			
			var renderer_Age = 0;
			var dataController = undefined;
			var fev_legend = undefined;
			
			require(["dojo/ready", "js/DataController"],function(ready, DataController){ 
				ready(function(){
					dataController = new DataController();
					updateFEVChart();
				});
			});
			
			function writeLungAge(actualAge, lungAge, lungAgeAt25) {
				var element = document.getElementById("predicted_lungAge");
            	if (element)
            	{
        			var pack = userData["Packs Per Day"];
        			if (pack > 0.0)
        			{
        			   	var asthmaScaling = asthmaLevel[userData['Asthma Severity']];
        			   	if (1.0 > asthmaScaling) {
        					element.innerHTML = "Smoking on top of the reduced lung function with asthma has significant risks: medical advice is recommended.";
        				} else {
        					if (actualAge >= 25) 
        						element.innerHTML =  "You are a " + actualAge + " year old " + userData["Gender"].toLowerCase() + ". Based on your smoking history, your lung function is estimated to be equavalent to an average " + lungAge + " year old non-smoker."
        					else {
        						var packString = "packs";
        						if (userData["Packs Per Day"] == 1)
        							packString = "pack";
        						element.innerHTML =  "You are a " + actualAge + " year old " + userData["Gender"].toLowerCase() + ". If you keep smoking " + userData["Packs Per Day"] + " " + packString +  " per day, at 25 year old, your lung function is estimated to be equavalent to an average " + lungAgeAt25 + " year old non-smoker."
        					}
        				}
        			}	
        			else {
        				element.innerHTML =  "You are not currently smoking, great job! Stay healthy."	
        			}
        			element.style.font = "italic bold 20px arial,serif";
        		}
        		
			}
		
			function updateFEVChart() {
				var asthmaScaling = asthmaLevel[userData['Asthma Severity']]
				var fev_chart = document.getElementById("fev_chart");
				dataController.createPlot(fev_chart, "age", "FEV1");
				var age = Math.floor(userData["Current Age"] + 0.5);
				var fevData = dataController.calculateFEVData(age, userData["Gender"].toLowerCase(),
					age - userData["Age started smoking"], userData["Packs Per Day"], userData["Height"], asthmaScaling);
				dataController.removeSeries(fev_chart, "non smoker");
				dataController.removeSeries(fev_chart, "smoker");
				dataController.removeSeries(fev_chart, "after cessation");
				dataController.addSeries(fev_chart, "You: at current rate of smoking", fevData[4], "red");
				dataController.addSeries(fev_chart, "Healthy, never smoked", fevData[3], "blue");
				dataController.addSeries(fev_chart, "You: non-smoking from now", fevData[5], "green");
				dataController.renderPlot(fev_chart);
				if (fev_legend == undefined) {
					fev_legend = document.getElementById("fev_legend");
					dataController.createLegend(fev_chart, fev_legend);
				}
				var lungAge = dataController.findLungAge(age, fevData[0], fevData[1]);
				var lungAgeAt25 = dataController.findLungAge(25, fevData[0], fevData[1]);
				writeLungAge(age, lungAge, lungAgeAt25);
			}
		
			function sidebar_click()
			{
				if (document.getElementById('my_sidebar').className == 'sidebar sidebar-left sidebar-open')
					document.getElementById('my_sidebar').className = 'sidebar sidebar-left sidebar-closed';
				else
					document.getElementById('my_sidebar').className = 'sidebar sidebar-left sidebar-open';
			}
			
			function updateUniformsWithDetails() {
				var age = Math.floor(userData["Current Age"] + 0.5);
				start_age = userData["Age started smoking"] * 0.01;
				if (start_age < 0.0)
					start_age = 0.0;
				cellUniforms["starting_time"].value = start_age;
				cellUniforms["severity"].value = userData["Packs Per Day"] * 1.0;
				flowUniforms["starting_time"].value = start_age;
				flowUniforms["severity"].value = userData["Packs Per Day"] * 1.0;
			}
			
			function airwaysMeshReady(scene, shaderText) {
				return function(bufferGeometry) {
					var flowMaterial = new THREE.ShaderMaterial( {
						vertexShader: shaderText[0],
						fragmentShader: shaderText[1],
						uniforms: flowUniforms
					} );
					flowMaterial.side = THREE.DoubleSide;
					flowMaterial.depthTest = true;
					scene.addZincGeometry(bufferGeometry, 10001, undefined, undefined, false, false, true, undefined, flowMaterial);
					scene.viewAll();
					airwaysIsReady = true;
				}
			}
			
			function lungsMeshReady(shaderText) {
				return function(mygeometry) {
					var lungsMaterial = new THREE.ShaderMaterial( {
						vertexShader: shaderText[0],
						fragmentShader: shaderText[1],
						uniforms: cellUniforms
					} );
					lungsMaterial.side = THREE.DoubleSide;
					mygeometry.setMaterial(lungsMaterial)
					lungMeshIsReady = true;
					updateUniformsWithDetails();
				}
			}
			
			function updateUniforms(zincRenderer, cellUniforms, flowUniforms) {
				return function () {
					var directionalLight = zincRenderer.getCurrentScene().directionalLight;
					cellUniforms["directionalLightDirection"].value.set(directionalLight.position.x,
						directionalLight.position.y,
						directionalLight.position.z);
					flowUniforms["directionalLightDirection"].value.set(directionalLight.position.x,
						directionalLight.position.y,
						directionalLight.position.z);
					cellUniforms["time"].value = zincRenderer.getCurrentTime()/3000.0;
					flowUniforms["time"].value = zincRenderer.getCurrentTime()/3000.0;
					var age = parseInt(cellUniforms["time"].value *100.0);
					if (age != renderer_Age) {
						renderer_Age = age;
						var element = document.getElementById("renderer_Age");
						if (element)
							element.innerHTML =  "Simulated Age: " + renderer_Age;
					}
					if (zincRenderer.playAnimation == true)
					{
						var sliderElement = document.getElementById("age_slider");
						sliderElement.value = renderer_Age;
					}
				};
			}
			
			function showModels(modelsName) {
				console.log(modelsName);
				var myTime = zincRenderer.getCurrentTime();
				if (modelsName == "Airways") {
					zincRenderer.setCurrentScene(airwaysScene);
				} else {
					zincRenderer.setCurrentScene(lungsScene);
				}
				zincRenderer.setMorphsTime(myTime);		
			}
			
			function datGuiChanged() {
				var packsPerDay = userData["Packs Per Day"] * 10.0;
				packsPerDay = Math.round(packsPerDay) / 10.0;
				userData["Packs Per Day"] = packsPerDay;
				if (dataController)
					updateFEVChart();
				if (zincRenderer)
				{
					zincRenderer.setPlayRate(userData['Speed']);
					showModels(viewingModel[userData['3D Models']]);
					updateUniformsWithDetails();
				}
			}
			
			function updateDatGui()
			{
				  for (var i in gui.__controllers) {
    				gui.__controllers[i].updateDisplay();
 				 }
			}
			
			function initDatGUI() {
				dat.GUI.TEXT_CLOSED = "Finish";
				dat.GUI.TEXT_OPEN  = "How about my lungs?";
				var gui = new dat.GUI();
				gui.close();
				gui.width = 350;
				var resetViewButton = { 'Reset view':function(){ zincRenderer.viewAll(); }};
				gui.add( userData, 'Current Age', 1, 99, 1 ).onChange( datGuiChanged );
				gui.add( userData, 'Asthma Severity', Object.keys( asthmaLevel ) ).onChange( datGuiChanged );
				gui.add( userData, 'Gender', Object.keys( gender ) ).onChange( datGuiChanged );
				gui.add( userData, 'Age started smoking', 0, 99, 1 ).onChange( datGuiChanged );
				var packsController = gui.add( userData, 'Packs Per Day', 0, 5, 0.1 ).onChange( datGuiChanged );
				gui.add( userData, 'Height', 70, 250, 1 ).onChange( datGuiChanged );
				gui.add( userData, '3D Models', Object.keys(viewingModel)).onChange( datGuiChanged );
				gui.add( userData, 'Speed', 100, 2000, 100).onChange( datGuiChanged );
				gui.add(resetViewButton,'Reset view');
				datGuiChanged();
			}
			
			function initCollapsibleGUI() {
    			$("#lungPanel").on('shown.bs.collapse', function(){
        			if (dataController)
						updateFEVChart();
					else
						alert('Char is not yet available, please try again later.');
    			});
			}
			
			function initGUI()
			{
				initDatGUI();
				initCollapsibleGUI();
			}
			
			container = document.getElementById( "container" );
			
			function init3Dmodels() {
				zincRenderer = new Zinc.Renderer(container, window);
				zincRenderer.initialiseVisualisation();
				zincRenderer.addPreRenderCallbackFunction(updateUniforms(zincRenderer, cellUniforms, flowUniforms));
				lungsScene = zincRenderer.createScene("Lungs");
				loadExternalFiles(['shaders/clean_cell.vs', 'shaders/clean_cell.fs'], function (shaderText) {
					lungsScene.loadFromViewURL('lung_2/lung2', lungsMeshReady(shaderText));
				}, function (url) {
				    alert('Failed to download "' + url + '"');
				});
				zincRenderer.setCurrentScene(lungsScene);
				if (airwaysScene == undefined)
				{
					airwaysScene = zincRenderer.createScene("Airways");
					airwaysScene.loadViewURL('airways/smoker_flow_view.json');
					loadExternalFiles(['shaders/dynamic_flow.vs', 'shaders/dynamic_flow.fs'], function (shaderText) {
						loadURLsIntoBufferGeometry('airways/smoker_flow_1.json', airwaysMeshReady(airwaysScene, shaderText));
					}, function (url) {
				  	alert('Failed to download "' + url + '"');
					});
				}	
				
				
				zincRenderer.setPlayRate(500);
				zincRenderer.playAnimation = false;
				zincRenderer.animate();
			}

			initGUI();
			init3Dmodels();

		</script>

	</body>
</html>
